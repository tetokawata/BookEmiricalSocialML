[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Rによる比較・因果推論・予測研究",
    "section": "",
    "text": "定量的な比較、（反実仮想）因果推定、予測分析をRによって行う方法を紹介\n経済学におけるデータ分析の大部分は、複数の変数間での関係性の理解・利用を目的としている。 本ページでは、ある結果変数\\(Y\\)と独立変数（群）\\(X=X_1,...,X_L\\)の関係性に焦点を当てる。 また\\(Y\\)と\\(X\\)がともに観察でき、関心のある母集団からランダムサンプリングされたデータが入手出来ている。\n具体的な分析目標を大きく（予測）\\(Y\\)の予測関数の推定、（比較）異なる\\(X\\)間での\\(Y\\)の比較、（因果効果）\\(X\\)の変化が\\(Y\\)に与える因果効果の推定、に大別し、それぞれについて簡単な説明とRのサンプルコードの提供\nデータインポート、整理、可視化を行う関数群を統合的に提供するtidyverseパッケージの利用\nExample dataとしては、AERパッケージに含まれるNMES1988(the US National Medical Expenditure Survey)を利用"
  },
  {
    "objectID": "intro.html",
    "href": "intro.html",
    "title": "1  準備",
    "section": "",
    "text": "本ページでは、tidyverseパッケージの利用を前提とし、pipe演算子を用いたコード例を示す"
  },
  {
    "objectID": "intro.html#tidyverse",
    "href": "intro.html#tidyverse",
    "title": "1  準備",
    "section": "1.1 tidyverse",
    "text": "1.1 tidyverse\n\nデータ整備・可視化等の関数群を提供する（メタ）パッケージ\n\n公式ページ"
  },
  {
    "objectID": "intro.html#nativeなpipe演算子",
    "href": "intro.html#nativeなpipe演算子",
    "title": "1  準備",
    "section": "1.2 nativeなpipe演算子",
    "text": "1.2 nativeなpipe演算子\n\nR version 4.1からpipe演算子が、追加パッケージなしで利用可能になった\n\nTools -> Global option -> Code -> “Use native pipe operator” をチェックする\nCtr + Shift + mがショートカット\n現状、magrittrパッケージが提供するpipe (%>%)に比べて、機能が限定されている\n\npipe演算子：二つの入力X1,X2から出力Yを得る関数fについて、pipe演算子を用いると、Y <- X1 |> f(X2)と書き換えられる\npipe演算子を使わない場合、ある出力結果を入力として用いるためには、複数のobjectを作成する必要があり煩雑\n\n\nn <- rnorm(100) # 標準正規分布から100個値を取得し、nと名付ける\n\nhist(n)　# nを用いてヒストグラムを描画\n\n\n\n\n\npipe演算子を使うと以下のようになる\n\n\nrnorm(100) |> \n  hist()"
  },
  {
    "objectID": "ParameterEstimation.html",
    "href": "ParameterEstimation.html",
    "title": "2  線形モデルの推定",
    "section": "",
    "text": "関心のあるパラメータ\\(\\tau(X)=E[Y|d,X]-E[Y|d',X]\\)を埋め込んだ線形モデルを推定する。\n\n典型的には、\\(E[Y|D,X]\\)を線形近似し、推定する。\n\\[E[Y|D=d,X=x]=\\underbrace{\\tau}_{Interest\\ parameter}\\times d+\\underbrace{f(x)}_{Nuisance\\ function}\\]"
  },
  {
    "objectID": "ParameterEstimation.html#パッケージ-データ",
    "href": "ParameterEstimation.html#パッケージ-データ",
    "title": "2  線形モデルの推定",
    "section": "2.1 パッケージ & データ",
    "text": "2.1 パッケージ & データ\n\nlibrary(tidyverse)\nlibrary(AER)\nlibrary(estimatr)\nlibrary(MatchIt)\n\ndata(\"NMES1988\")\n\nraw <- na.omit(NMES1988)"
  },
  {
    "objectID": "ParameterEstimation.html#線形モデルの推定",
    "href": "ParameterEstimation.html#線形モデルの推定",
    "title": "2  線形モデルの推定",
    "section": "2.2 線形モデルの推定",
    "text": "2.2 線形モデルの推定\n\n\\(\\tau(x)=\\tau,f(x)=\\beta_0+\\beta_1x_1+...+\\beta_Lx_L\\)と特定化\nサンプル内MSEを最大化するように推定\nrobust standard errorを計算するためにestimatrパッケージ(R-estimatr?)を利用\nlm_robust関数で推定\n\n\nlm_robust(visits ~ insurance + region + age + afam + gender + school + income + employed + married,\n          data = raw)\n\n                   Estimate Std. Error    t value     Pr(>|t|)    CI Lower\n(Intercept)      4.32086605 1.30928537  3.3001713 9.739642e-04  1.75400683\ninsuranceyes     0.96591490 0.24785140  3.8971533 9.877947e-05  0.48000123\nregionnortheast  0.34814737 0.30392728  1.1454957 2.520663e-01 -0.24770327\nregionmidwest   -0.40583622 0.25526934 -1.5898354 1.119439e-01 -0.90629278\nregionwest       0.57163030 0.30418463  1.8792215 6.028038e-02 -0.02472489\nage              0.04293421 0.15977094  0.2687235 7.881551e-01 -0.27029737\nafamyes         -0.39294341 0.34701206 -1.1323624 2.575439e-01 -1.07326195\ngendermale      -0.46726544 0.22050124 -2.1191057 3.413748e-02 -0.89955902\nschool           0.08475793 0.03108035  2.7270588 6.415540e-03  0.02382479\nincome          -0.04678801 0.03712934 -1.2601357 2.076873e-01 -0.11958023\nemployedyes     -0.34186375 0.42407955 -0.8061312 4.202108e-01 -1.17327342\nmarriedyes      -0.29559842 0.23244624 -1.2716851 2.035523e-01 -0.75131020\n                   CI Upper   DF\n(Intercept)      6.88772528 4394\ninsuranceyes     1.45182856 4394\nregionnortheast  0.94399802 4394\nregionmidwest    0.09462034 4394\nregionwest       1.16798549 4394\nage              0.35616578 4394\nafamyes          0.28737512 4394\ngendermale      -0.03497187 4394\nschool           0.14569108 4394\nincome           0.02600421 4394\nemployedyes      0.48954591 4394\nmarriedyes       0.16011336 4394\n\n\n\n線形モデルによる推定は、いくつかの問題がある\n\n異なるグループ間で、\\(X\\)の分布が異なる場合、回帰式の定式化に強く依存する\n一般に平均効果ではなく、加重平均が推計される\nサンプルサイズに比べて、少数のコントロール変数を導入できない\n\n以下ではマッチング法、機械学手法を用いた頑強な推定を目指す\n\n\n2.2.1 RCTデータへの応用\n\n原因変数が完全にランダム化されている場合、因果効果の識別を目的に回帰分析を応用する必要はない\n因果効果の推定の改善、効率性向上、を目的として線形モデルの利用は議論されてきた。(freedman2008regressiona?; freedman2008regressionb?)\n(lin2013agnostic?)は、以下のような交差項を導入したモデルを用いることで、平均の差の推定に比べて、漸近的効率性が悪化することはない（同等か改善する）ことを示した\n\n\\[E[Y|D,X]=\\beta_{D}\\times D+\\beta_1\\times X_1+...+\\beta_L\\times X_L\\]\n\\[+\\underbrace{\\beta_{1D}\\times D\\times X_1+...+\\beta_{LD}\\times D\\times X_L}_{交差項}\\]"
  },
  {
    "objectID": "ParameterEstimation.html#マッチング法による修正",
    "href": "ParameterEstimation.html#マッチング法による修正",
    "title": "2  線形モデルの推定",
    "section": "2.3 マッチング法による修正",
    "text": "2.3 マッチング法による修正\n\n回帰を行う事前準備としてマッチング法を利用する\n\n重回帰が持つ関数形への依存度を減らせる (ho2007matching?)\nMathItパッケージ (MatchIt2011?)を利用\n\n多数のマッチング法が実装されている\n\n\n2.3.1 Exact matching\n\n\\(X\\)が完全に同じサンプル同士をマッチングする\n原因変数の分布に偏りがある場合（本例ではコントロールグループが少ない）、少ないグループ内での平均効果(Average treatment effect for treat または control)の推定を目指すことでマッチできないサンプルを減らすことが期待できる。\n\n\nfit.m <- matchit(insurance ~ region + age + afam + gender + school+ married + employed,\n                 data = raw,\n                 method = \"exact\",\n                 estimand = \"ATC\"\n                 )\n\n\nこの例では、incomeもコントロール変数に加えた場合、Exact matching不可能（一つもマッチングできない）\nマッチング結果の表示\n\n\nsummary(fit.m)\n\n\nCall:\nmatchit(formula = insurance ~ region + age + afam + gender + \n    school + married + employed, data = raw, method = \"exact\", \n    estimand = \"ATC\")\n\nSummary of Balance for All Data:\n                Means Treated Means Control Std. Mean Diff. Var. Ratio\nregionnortheast        0.1938        0.1766          0.0450          .\nregionmidwest          0.2882        0.1736          0.3026          .\nregionwest             0.1818        0.1787          0.0082          .\nregionother            0.3362        0.4711         -0.2703          .\nage                    7.3737        7.5021         -0.1849     0.7752\nafamno                 0.9380        0.6914          0.5340          .\nafamyes                0.0620        0.3086         -0.5340          .\ngenderfemale           0.5849        0.6365         -0.1073          .\ngendermale             0.4151        0.3635          0.1073          .\nschool                10.9547        7.9827          0.7549     0.7464\nmarriedno              0.4028        0.6315         -0.4740          .\nmarriedyes             0.5972        0.3685          0.4740          .\nemployedno             0.8857        0.9350         -0.2001          .\nemployedyes            0.1143        0.0650          0.2001          .\n                eCDF Mean eCDF Max\nregionnortheast    0.0172   0.0172\nregionmidwest      0.1146   0.1146\nregionwest         0.0031   0.0031\nregionother        0.1349   0.1349\nage                0.0357   0.0936\nafamno             0.2467   0.2467\nafamyes            0.2467   0.2467\ngenderfemale       0.0516   0.0516\ngendermale         0.0516   0.0516\nschool             0.1564   0.3248\nmarriedno          0.2287   0.2287\nmarriedyes         0.2287   0.2287\nemployedno         0.0493   0.0493\nemployedyes        0.0493   0.0493\n\n\nSummary of Balance for Matched Data:\n                Means Treated Means Control Std. Mean Diff. Var. Ratio\nregionnortheast        0.2107        0.2107               0          .\nregionmidwest          0.2201        0.2201               0          .\nregionwest             0.1384        0.1384               0          .\nregionother            0.4308        0.4308               0          .\nage                    7.3296        7.3296               0     0.9998\nafamno                 0.9434        0.9434               0          .\nafamyes                0.0566        0.0566               0          .\ngenderfemale           0.6887        0.6887               0          .\ngendermale             0.3113        0.3113               0          .\nschool                 9.9277        9.9277               0     0.9998\nmarriedno              0.5283        0.5283               0          .\nmarriedyes             0.4717        0.4717               0          .\nemployedno             0.9560        0.9560               0          .\nemployedyes            0.0440        0.0440               0          .\n                eCDF Mean eCDF Max Std. Pair Dist.\nregionnortheast         0        0               0\nregionmidwest           0        0               0\nregionwest              0        0               0\nregionother             0        0               0\nage                     0        0               0\nafamno                  0        0               0\nafamyes                 0        0               0\ngenderfemale            0        0               0\ngendermale              0        0               0\nschool                  0        0               0\nmarriedno               0        0               0\nmarriedyes              0        0               0\nemployedno              0        0               0\nemployedyes             0        0               0\n\nSample Sizes:\n              Control Treated\nAll               985 3421.  \nMatched (ESS)     318  338.39\nMatched           318  624.  \nUnmatched         667 2797.  \nDiscarded           0    0.  \n\n\n\nSample sizesにて、マッチングできなかったサンプル数（985のコントロールグループ中、667サンプルがマッチングできなかった）が確認できる\nマッチング結果の図示\n\n\nfit.m |> \n  summary() |> \n  plot(xlim = c(0,2))\n\n\n\n\n\nマッチング結果を変数として含んだデータを作成\n\n\ndf <- match.data(fit.m)\n\n\n“subclass”: マッチングしたグループ\n“weights”：マッチング後の推計に用いるウェイト\nマッチングしたデータを用いた推定\n\n新たに作成されるweight (defaltではweights)を用いた、加重推定で実装\n\n\n\nlm_robust(visits ~ insurance,\n          df,\n          weights = weights)\n\n             Estimate Std. Error   t value     Pr(>|t|)  CI Lower CI Upper  DF\n(Intercept)  4.707547  0.2978972 15.802589 4.605531e-50 4.1229266 5.292168 940\ninsuranceyes 1.481104  0.4842812  3.058355 2.288589e-03 0.5307064 2.431501 940\n\n\n\n\n2.3.2 Coarsened exact matching\n\nCoarsened exact matching(iacus2012causal?)の実装\n\n連続変数をカテゴリー変数化することで、マッチングできるサンプルサイズを増やすことが期待できる\n\n\n\nfit.m <- matchit(insurance ~ region + age + afam + gender + school+ married + employed + income,\n                 data = raw,\n                 method = \"cem\",\n                 estimand = \"ATC\")\n\n\nマッチング結果\n\n\nsummary(fit.m)\n\n\nCall:\nmatchit(formula = insurance ~ region + age + afam + gender + \n    school + married + employed + income, data = raw, method = \"cem\", \n    estimand = \"ATC\")\n\nSummary of Balance for All Data:\n                Means Treated Means Control Std. Mean Diff. Var. Ratio\nregionnortheast        0.1938        0.1766          0.0450          .\nregionmidwest          0.2882        0.1736          0.3026          .\nregionwest             0.1818        0.1787          0.0082          .\nregionother            0.3362        0.4711         -0.2703          .\nage                    7.3737        7.5021         -0.1849     0.7752\nafamno                 0.9380        0.6914          0.5340          .\nafamyes                0.0620        0.3086         -0.5340          .\ngenderfemale           0.5849        0.6365         -0.1073          .\ngendermale             0.4151        0.3635          0.1073          .\nschool                10.9547        7.9827          0.7549     0.7464\nmarriedno              0.4028        0.6315         -0.4740          .\nmarriedyes             0.5972        0.3685          0.4740          .\nemployedno             0.8857        0.9350         -0.2001          .\nemployedyes            0.1143        0.0650          0.2001          .\nincome                 2.7759        1.6630          0.5889     2.7193\n                eCDF Mean eCDF Max\nregionnortheast    0.0172   0.0172\nregionmidwest      0.1146   0.1146\nregionwest         0.0031   0.0031\nregionother        0.1349   0.1349\nage                0.0357   0.0936\nafamno             0.2467   0.2467\nafamyes            0.2467   0.2467\ngenderfemale       0.0516   0.0516\ngendermale         0.0516   0.0516\nschool             0.1564   0.3248\nmarriedno          0.2287   0.2287\nmarriedyes         0.2287   0.2287\nemployedno         0.0493   0.0493\nemployedyes        0.0493   0.0493\nincome             0.1920   0.3244\n\n\nSummary of Balance for Matched Data:\n                Means Treated Means Control Std. Mean Diff. Var. Ratio\nregionnortheast        0.1663        0.1663         -0.0000          .\nregionmidwest          0.2026        0.2026         -0.0000          .\nregionwest             0.1471        0.1471         -0.0000          .\nregionother            0.4840        0.4840         -0.0000          .\nage                    7.3175        7.3117          0.0084     0.9786\nafamno                 0.8486        0.8486          0.0000          .\nafamyes                0.1514        0.1514         -0.0000          .\ngenderfemale           0.6652        0.6652         -0.0000          .\ngendermale             0.3348        0.3348         -0.0000          .\nschool                 9.2821        9.2601          0.0056     0.9798\nmarriedno              0.5458        0.5458         -0.0000          .\nmarriedyes             0.4542        0.4542         -0.0000          .\nemployedno             0.9659        0.9659          0.0000          .\nemployedyes            0.0341        0.0341         -0.0000          .\nincome                 1.6947        1.4311          0.1395     0.9181\n                eCDF Mean eCDF Max Std. Pair Dist.\nregionnortheast    0.0000   0.0000          0.0000\nregionmidwest      0.0000   0.0000          0.0000\nregionwest         0.0000   0.0000          0.0000\nregionother        0.0000   0.0000          0.0000\nage                0.0040   0.0237          0.1533\nafamno             0.0000   0.0000          0.0000\nafamyes            0.0000   0.0000          0.0000\ngenderfemale       0.0000   0.0000          0.0000\ngendermale         0.0000   0.0000          0.0000\nschool             0.0018   0.0158          0.0211\nmarriedno          0.0000   0.0000          0.0000\nmarriedyes         0.0000   0.0000          0.0000\nemployedno         0.0000   0.0000          0.0000\nemployedyes        0.0000   0.0000          0.0000\nincome             0.0845   0.1898          0.3971\n\nSample Sizes:\n              Control Treated\nAll               985 3421.  \nMatched (ESS)     469  438.65\nMatched           469 1196.  \nUnmatched         516 2225.  \nDiscarded           0    0.  \n\n\n\n可視化\n\n\nfit.m |> \n  summary() |> \n  plot(xlim = c(0,2))\n\n\n\n\n\nExact matching以外のマッチング法では、マッチングされたサンプル内でも\\(X\\)の違いが残る\n\nマッチングされたサンプル内で回帰分析を行うことで、再調整する\n\n\n\ndf <- match.data(fit.m)\n\nlm_robust(visits ~ insurance + region + age + afam + gender + school+ married + employed + income,\n          df,\n          weights = weights)\n\n                   Estimate Std. Error     t value     Pr(>|t|)    CI Lower\n(Intercept)      0.07031894  3.1830746  0.02209152 9.823776e-01 -6.17296408\ninsuranceyes     1.63803136  0.4111893  3.98364310 7.081498e-05  0.83152463\nregionnortheast  0.37332676  0.6686084  0.55836385 5.766716e-01 -0.93808186\nregionmidwest   -1.01255860  0.4957411 -2.04251498 4.125884e-02 -1.98490525\nregionwest       1.46720871  0.9811751  1.49535874 1.350117e-01 -0.45726821\nage              0.54604701  0.4139224  1.31920151 1.872845e-01 -0.26582038\nafamyes         -1.09566719  0.8327555 -1.31571289 1.884529e-01 -2.72903401\ngendermale      -0.77640463  0.5006594 -1.55076411 1.211496e-01 -1.75839805\nschool           0.16064654  0.1041628  1.54226418 1.232008e-01 -0.04365837\nmarriedyes      -0.16566757  0.5419170 -0.30570652 7.598666e-01 -1.22858372\nemployedyes     -1.47819362  1.1718433 -1.26142599 2.073334e-01 -3.77664729\nincome          -0.36310301  0.1778814 -2.04126501 4.138301e-02 -0.71199956\n                   CI Upper   DF\n(Intercept)      6.31360197 1653\ninsuranceyes     2.44453809 1653\nregionnortheast  1.68473538 1653\nregionmidwest   -0.04021195 1653\nregionwest       3.39168562 1653\nage              1.35791440 1653\nafamyes          0.53769963 1653\ngendermale       0.20558879 1653\nschool           0.36495144 1653\nmarriedyes       0.89724858 1653\nemployedyes      0.82026004 1653\nincome          -0.01420647 1653\n\n\n\n\n2.3.3 Propensity score with subclassification\n\nCoarsened exact matchingでもマッチングできないサンプルが多数出てくる可能性\n\nとくに\\(X\\)が大量にある場合\n\n1次元の距離指標を用いて、マッチングを行う\n\n距離指標としては、Mahalanobis’ Distance、Propensity scoreなど\n\nここではPropensity score \\(p_d(X)\\)を用いる\n\n\\[p_d(X)\\equiv \\Pr[D=d|X]\\]\n\n属性\\(X\\)のユニットの中で、原因変数の値が\\(d\\)である人の割合\n未知の場合、データから推定する必要がある\n推定された傾向スコアを用いたStratification マッチング\n-　ロジットにて傾向スコアを推定\n\n\nfit.m <- matchit(insurance ~ region + age + afam + gender + school+ married + employed + income,\n                 data = raw,\n                 method = \"subclass\",\n                 estimand = \"ATC\"\n                 )\n\n\nマッチング結果\n\n\nsummary(fit.m)\n\n\nCall:\nmatchit(formula = insurance ~ region + age + afam + gender + \n    school + married + employed + income, data = raw, method = \"subclass\", \n    estimand = \"ATC\")\n\nSummary of Balance for All Data:\n                Means Treated Means Control Std. Mean Diff. Var. Ratio\ndistance               0.8230        0.6148          0.8783     0.3568\nregionnortheast        0.1938        0.1766          0.0450          .\nregionmidwest          0.2882        0.1736          0.3026          .\nregionwest             0.1818        0.1787          0.0082          .\nregionother            0.3362        0.4711         -0.2703          .\nage                    7.3737        7.5021         -0.1849     0.7752\nafamno                 0.9380        0.6914          0.5340          .\nafamyes                0.0620        0.3086         -0.5340          .\ngenderfemale           0.5849        0.6365         -0.1073          .\ngendermale             0.4151        0.3635          0.1073          .\nschool                10.9547        7.9827          0.7549     0.7464\nmarriedno              0.4028        0.6315         -0.4740          .\nmarriedyes             0.5972        0.3685          0.4740          .\nemployedno             0.8857        0.9350         -0.2001          .\nemployedyes            0.1143        0.0650          0.2001          .\nincome                 2.7759        1.6630          0.5889     2.7193\n                eCDF Mean eCDF Max\ndistance           0.2750   0.4285\nregionnortheast    0.0172   0.0172\nregionmidwest      0.1146   0.1146\nregionwest         0.0031   0.0031\nregionother        0.1349   0.1349\nage                0.0357   0.0936\nafamno             0.2467   0.2467\nafamyes            0.2467   0.2467\ngenderfemale       0.0516   0.0516\ngendermale         0.0516   0.0516\nschool             0.1564   0.3248\nmarriedno          0.2287   0.2287\nmarriedyes         0.2287   0.2287\nemployedno         0.0493   0.0493\nemployedyes        0.0493   0.0493\nincome             0.1920   0.3244\n\nSummary of Balance Across Subclasses\n                Means Treated Means Control Std. Mean Diff. Var. Ratio\ndistance               0.6264        0.6148          0.0486     0.9752\nregionnortheast        0.1752        0.1766         -0.0039          .\nregionmidwest          0.1941        0.1736          0.0542          .\nregionwest             0.1915        0.1787          0.0335          .\nregionother            0.4392        0.4711         -0.0638          .\nage                    7.4961        7.5021         -0.0087     0.8894\nafamno                 0.6956        0.6914          0.0092          .\nafamyes                0.3044        0.3086         -0.0092          .\ngenderfemale           0.5977        0.6365         -0.0807          .\ngendermale             0.4023        0.3635          0.0807          .\nschool                 8.0956        7.9827          0.0287     1.0967\nmarriedno              0.6000        0.6315         -0.0653          .\nmarriedyes             0.4000        0.3685          0.0653          .\nemployedno             0.9157        0.9350         -0.0782          .\nemployedyes            0.0843        0.0650          0.0782          .\nincome                 1.9086        1.6630          0.1300     1.3758\n                eCDF Mean eCDF Max\ndistance           0.0133   0.0457\nregionnortheast    0.0015   0.0015\nregionmidwest      0.0205   0.0205\nregionwest         0.0128   0.0128\nregionother        0.0319   0.0319\nage                0.0133   0.0339\nafamno             0.0042   0.0042\nafamyes            0.0042   0.0042\ngenderfemale       0.0388   0.0388\ngendermale         0.0388   0.0388\nschool             0.0109   0.0311\nmarriedno          0.0315   0.0315\nmarriedyes         0.0315   0.0315\nemployedno         0.0193   0.0193\nemployedyes        0.0193   0.0193\nincome             0.0622   0.1485\n\nSample Sizes:\n              Control Treated\nAll               985 3421.  \nMatched (ESS)     985  999.44\nMatched           985 3421.  \nUnmatched           0    0.  \nDiscarded           0    0.  \n\n\n\nマッチング結果の図示\n\n\nfit.m |> \n  summary() |> \n  plot(xlim = c(0,2))\n\n\n\n\n\nマッチングしたデータを用いた推定\n\n\ndf <- match.data(fit.m) # マッチング結果を含んだ\n\nlm_robust(visits ~ insurance + region + age + afam + gender + school+ married + employed,\n          df,\n          weights = weights)\n\n                   Estimate Std. Error    t value    Pr(>|t|)    CI Lower\n(Intercept)      2.69483196 1.56827266  1.7183440 0.085804312 -0.37977270\ninsuranceyes     0.86429413 0.30326930  2.8499229 0.004393338  0.26973348\nregionnortheast  0.32880379 0.47161144  0.6971921 0.485719430 -0.59579228\nregionmidwest   -0.72444843 0.38788012 -1.8677122 0.061868702 -1.48488891\nregionwest       0.36858393 0.43102618  0.8551312 0.392525130 -0.47644456\nage              0.32472400 0.19637511  1.6535904 0.098282174 -0.06027016\nafamyes         -0.73188348 0.46736086 -1.5659923 0.117422424 -1.64814626\ngendermale      -1.02017368 0.34142463 -2.9879909 0.002823707 -1.68953801\nschool           0.05542150 0.04126024  1.3432182 0.179270695 -0.02546936\nmarriedyes      -0.07195191 0.30991060 -0.2321699 0.816416863 -0.67953285\nemployedyes     -0.54902900 0.45865317 -1.1970461 0.231353145 -1.44822033\n                   CI Upper   DF\n(Intercept)      5.76943662 4395\ninsuranceyes     1.45885478 4395\nregionnortheast  1.25339987 4395\nregionmidwest    0.03599205 4395\nregionwest       1.21361243 4395\nage              0.70971816 4395\nafamyes          0.18437930 4395\ngendermale      -0.35080936 4395\nschool           0.13631236 4395\nmarriedyes       0.53562902 4395\nemployedyes      0.35016234 4395\n\n\n\n\n2.3.4 Nearest neighbor matching\n\n傾向スコアを用いた最近旁マッチング\n\n傾向スコアがもっとも似ているサンプルとマッチングする\nデフォルトでは、Replacement無しのマッチングを行う\n\n\n\nfit.m <- matchit(insurance ~ region + age + afam + gender + school+ married + employed + income,\n                 data = raw,\n                 method = \"nearest\",\n                 estimand = \"ATC\"\n                 )\n\n\nマッチング結果\n\n\nsummary(fit.m)\n\n\nCall:\nmatchit(formula = insurance ~ region + age + afam + gender + \n    school + married + employed + income, data = raw, method = \"nearest\", \n    estimand = \"ATC\")\n\nSummary of Balance for All Data:\n                Means Treated Means Control Std. Mean Diff. Var. Ratio\ndistance               0.8230        0.6148          0.8783     0.3568\nregionnortheast        0.1938        0.1766          0.0450          .\nregionmidwest          0.2882        0.1736          0.3026          .\nregionwest             0.1818        0.1787          0.0082          .\nregionother            0.3362        0.4711         -0.2703          .\nage                    7.3737        7.5021         -0.1849     0.7752\nafamno                 0.9380        0.6914          0.5340          .\nafamyes                0.0620        0.3086         -0.5340          .\ngenderfemale           0.5849        0.6365         -0.1073          .\ngendermale             0.4151        0.3635          0.1073          .\nschool                10.9547        7.9827          0.7549     0.7464\nmarriedno              0.4028        0.6315         -0.4740          .\nmarriedyes             0.5972        0.3685          0.4740          .\nemployedno             0.8857        0.9350         -0.2001          .\nemployedyes            0.1143        0.0650          0.2001          .\nincome                 2.7759        1.6630          0.5889     2.7193\n                eCDF Mean eCDF Max\ndistance           0.2750   0.4285\nregionnortheast    0.0172   0.0172\nregionmidwest      0.1146   0.1146\nregionwest         0.0031   0.0031\nregionother        0.1349   0.1349\nage                0.0357   0.0936\nafamno             0.2467   0.2467\nafamyes            0.2467   0.2467\ngenderfemale       0.0516   0.0516\ngendermale         0.0516   0.0516\nschool             0.1564   0.3248\nmarriedno          0.2287   0.2287\nmarriedyes         0.2287   0.2287\nemployedno         0.0493   0.0493\nemployedyes        0.0493   0.0493\nincome             0.1920   0.3244\n\n\nSummary of Balance for Matched Data:\n                Means Treated Means Control Std. Mean Diff. Var. Ratio\ndistance               0.6835        0.6148          0.2897     0.5687\nregionnortheast        0.1939        0.1766          0.0453          .\nregionmidwest          0.1878        0.1736          0.0375          .\nregionwest             0.1949        0.1787          0.0424          .\nregionother            0.4234        0.4711         -0.0956          .\nage                    7.4870        7.5021         -0.0218     0.8702\nafamno                 0.8010        0.6914          0.2374          .\nafamyes                0.1990        0.3086         -0.2374          .\ngenderfemale           0.6173        0.6365         -0.0401          .\ngendermale             0.3827        0.3635          0.0401          .\nschool                 8.5736        7.9827          0.1501     0.8404\nmarriedno              0.5909        0.6315         -0.0842          .\nmarriedyes             0.4091        0.3685          0.0842          .\nemployedno             0.9228        0.9350         -0.0494          .\nemployedyes            0.0772        0.0650          0.0494          .\nincome                 1.7858        1.6630          0.0650     0.7674\n                eCDF Mean eCDF Max Std. Pair Dist.\ndistance           0.0309   0.1827          0.2898\nregionnortheast    0.0173   0.0173          0.7800\nregionmidwest      0.0142   0.0142          0.7130\nregionwest         0.0162   0.0162          0.7897\nregionother        0.0477   0.0477          0.9173\nage                0.0133   0.0365          1.0470\nafamno             0.1096   0.1096          0.4879\nafamyes            0.1096   0.1096          0.4879\ngenderfemale       0.0193   0.0193          0.9224\ngendermale         0.0193   0.0193          0.9224\nschool             0.0318   0.0924          0.7555\nmarriedno          0.0406   0.0406          0.8292\nmarriedyes         0.0406   0.0406          0.8292\nemployedno         0.0122   0.0122          0.5437\nemployedyes        0.0122   0.0122          0.5437\nincome             0.0615   0.1472          0.7354\n\nSample Sizes:\n          Control Treated\nAll           985    3421\nMatched       985     985\nUnmatched       0    2436\nDiscarded       0       0\n\n\n\nマッチング結果の図示\n\n\nfit.m |> \n  summary() |> \n  plot(xlim = c(0,2))\n\n\n\n\n\nマッチングしたデータを用いた推定\n\nreplacement無しの場合ｍマッチングしたペア(subclass)でクラスタリングしたrobust standard errorの利用を推奨 (abadie2021robust?)\n\n\n\ndf <- match.data(fit.m) # マッチング結果を含んだ\n\nlm_robust(visits ~ insurance + region + age + afam + gender + school+ married + employed + income,\n          df,\n          clusters = subclass,\n          weights = weights)\n\n                   Estimate Std. Error    t value     Pr(>|t|)    CI Lower\n(Intercept)      4.28376769 1.80365512  2.3750481 0.0179117218  0.74034506\ninsuranceyes     0.88089215 0.27930681  3.1538513 0.0016606844  0.33277940\nregionnortheast  0.11745650 0.43169716  0.2720808 0.7856724490 -0.73071167\nregionmidwest   -1.09402106 0.34563753 -3.1652265 0.0016483956 -1.77317575\nregionwest       0.67689981 0.41977554  1.6125280 0.1074679565 -0.14780947\nage              0.15738399 0.21874416  0.7194889 0.4721765473 -0.27238904\nafamyes         -0.65822959 0.31824549 -2.0683077 0.0391049262 -1.28343451\ngendermale      -1.12983896 0.30900225 -3.6564101 0.0002772051 -1.73664207\nschool           0.04179621 0.03992562  1.0468521 0.2957240492 -0.03666544\nmarriedyes       0.26953526 0.28939461  0.9313762 0.3520209096 -0.29877535\nemployedyes     -0.28682948 0.69900943 -0.4103371 0.6821000780 -1.66715900\nincome          -0.18287346 0.07454076 -2.4533350 0.0158456243 -0.33072080\n                   CI Upper       DF\n(Intercept)      7.82719031 515.2437\ninsuranceyes     1.42900489 973.5096\nregionnortheast  0.96562467 498.9836\nregionmidwest   -0.41486638 478.5757\nregionwest       1.50160909 508.1414\nage              0.58715703 499.0168\nafamyes         -0.03302466 519.9827\ngendermale      -0.52303586 627.8155\nschool           0.12025787 454.6173\nmarriedyes       0.83784587 621.0176\nemployedyes      1.09350005 162.2410\nincome          -0.03502611 102.2246"
  },
  {
    "objectID": "ParameterEstimation.html#付録推定結果の保存と表示",
    "href": "ParameterEstimation.html#付録推定結果の保存と表示",
    "title": "2  線形モデルの推定",
    "section": "2.4 付録：推定結果の保存と表示",
    "text": "2.4 付録：推定結果の保存と表示\n\n2.4.1 推計結果表\n\ntidy関数により推定結果data.frameに変化することで、kable関数(knitrパッケージ)による推計結果表の整形、geom_pointrange関数による可視化が可能\n点推定値(estimate)、標準誤差(std.error)のみを残した推計結果表\n\n\nlibrary(knitr)\n\nlm_robust(visits ~ insurance + region + age + afam + gender + school,\n            data = raw\n            ) |> \n  tidy() |> \n  select(term, estimate, std.error) |> \n  kable(digits = 2)\n\n\n\n\nterm\nestimate\nstd.error\n\n\n\n\n(Intercept)\n3.65\n1.23\n\n\ninsuranceyes\n0.90\n0.25\n\n\nregionnortheast\n0.36\n0.30\n\n\nregionmidwest\n-0.40\n0.25\n\n\nregionwest\n0.55\n0.30\n\n\nage\n0.12\n0.15\n\n\nafamyes\n-0.35\n0.34\n\n\ngendermale\n-0.63\n0.21\n\n\nschool\n0.07\n0.03\n\n\n\n\n\n\nlm_robust(visits ~ insurance + region + age + afam + gender + school,\n            data = raw\n            ) |> \n  tidy() |> \n  select(term, estimate, std.error) |> \n  filter(term == \"insuranceyes\") |> \n  kable(digits = 2)\n\n\n\n\nterm\nestimate\nstd.error\n\n\n\n\ninsuranceyes\n0.9\n0.25\n\n\n\n\n\n\n\n2.4.2 Dot-and-Whisker plotによる可視化\n\nDot-and-Whisker図により点推定量と信頼区間を可視化\n\n\nlm_robust(visits ~ insurance + region + age + afam + gender + school,\n            data = raw) |> \n  tidy() |> \n  filter(term != \"(Intercept)\"\n         ) |> \n  ggplot(aes(y = term,\n             x = estimate,\n             xmin = conf.low,\n             xmax = conf.high)\n         ) +\n  geom_pointrange() +\n  geom_vline(xintercept = 0)\n\n\n\n\n\n\n2.4.3 サブサンプル分析結果の整理と可視化\n\n条件付き平均効果\\(=E[Y_i(d)-Y_i(d')|X_i=x]\\)\n\n因果効果の異質性を議論する上で、有力な要約値\n少数の\\(x\\)を分析者が事前設定する場合、\\(x\\)についてサブサンプルを作成し、推定すればOK\n\ntidyverseパッケージに含まれるnest/unnest関数を用いれば、整理したサブサンプル分析が可能でかつ、容易に可視化/表化できる\n\n推定結果を入子リスト形式に保存し、通常のデータフレーム形式に展開、可視化/表化する手順踏む\n関数をリストの構成要素に逐次適用する汎関数(map)を利用することで、同じデータフレーム内に結果を保存できる\n\n以下では”region”ごとに条件付き平均効果を推定する\n\n\nregression <-\n  function(df){\n    lm_robust(visits ~ insurance + age + afam + gender + school + income + employed + married,\n              data = df) |> \n      tidy() |> \n      filter(term == \"insuranceyes\")\n  } # 推計し、関心のあるパラメータのみからなるデータフレーム化する関数\n\nresult <- \n  raw |> \n  group_by(region) |> # regoinごとにサブグループ化\n  nest() |> # regionごとに入子データを作成\n  mutate(model = map(data,regression)) |> # 推定し、モデルとして結果をほぞpン\n  unnest() |> # 入子構造を解消\n  distinct(region,\n           estimate,\n           conf.low,\n           conf.high) # regionごとの結果表を作成\n\n\nデータフレームなので、容易に可視化できる\n\n\nresult |> \n  ggplot(aes(x = estimate,\n             y = region,\n             xmin = conf.low,\n             xmax = conf.high)\n         ) +\n  geom_pointrange() +\n  geom_vline(xintercept = 0)\n\n\n\n\n\n\n2.4.4 複数の推定結果の整理と可視化\n\nlistで保存し、data.frameに展開、という手順はより一般に複数の推定結果を整理することに使える\n\n\nlist <- list() # 空のリストを作成\n\nlist[[1]] <- \n  lm_robust(visits ~ insurance + age + afam + gender + school + income + employed + married +region,\n            data = raw) |> \n  tidy() |> \n  filter(term == \"insuranceyes\") # 推定結果をリストに保存\n\nlist[[2]] <- \n  lm_robust(nvisits ~ insurance + age + afam + gender + school + income + employed + married +region,\n            data = raw) |> \n  tidy() |> \n  filter(term == \"insuranceyes\") # 別の結果を保存\n\nnames(list) <- c(\"visits\",\"nvisits\") # 名づけ\n\nresult <-\n  enframe(list) |> \n  unnest() # データフレーム化\n\nresult |> \n  ggplot(aes(y = name,\n             x = estimate,\n             xmin = conf.low,\n             xmax = conf.high\n             )\n         ) +\n  geom_pointrange() # 可視化"
  },
  {
    "objectID": "summary.html",
    "href": "summary.html",
    "title": "3  Summary",
    "section": "",
    "text": "1 + 1\n\n[1] 2"
  }
]