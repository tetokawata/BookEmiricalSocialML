<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Rによる比較・因果推論・予測研究 - 2&nbsp; 線形モデルによるパラメータの推定</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./summary.html" rel="next">
<link href="./intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">線形モデルによるパラメータの推定</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Rによる比較・因果推論・予測研究</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">準備</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ParameterEstimation.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">線形モデルによるパラメータの推定</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">記述統計</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#パッケージ-データ" id="toc-パッケージ-データ" class="nav-link active" data-scroll-target="#パッケージ-データ"> <span class="header-section-number">2.1</span> パッケージ &amp; データ</a></li>
  <li><a href="#sec-ParameterEstimation" id="toc-sec-ParameterEstimation" class="nav-link" data-scroll-target="#sec-ParameterEstimation"> <span class="header-section-number">2.2</span> パラメータの推定</a>
  <ul class="collapse">
  <li><a href="#rctデータへの応用" id="toc-rctデータへの応用" class="nav-link" data-scroll-target="#rctデータへの応用"> <span class="header-section-number">2.2.1</span> RCTデータへの応用</a></li>
  </ul></li>
  <li><a href="#sec-Matching" id="toc-sec-Matching" class="nav-link" data-scroll-target="#sec-Matching"> <span class="header-section-number">2.3</span> マッチング法による修正</a>
  <ul class="collapse">
  <li><a href="#coarsened-exact-matching" id="toc-coarsened-exact-matching" class="nav-link" data-scroll-target="#coarsened-exact-matching"> <span class="header-section-number">2.3.1</span> Coarsened exact matching</a></li>
  <li><a href="#propensity-score-with-subclassification" id="toc-propensity-score-with-subclassification" class="nav-link" data-scroll-target="#propensity-score-with-subclassification"> <span class="header-section-number">2.3.2</span> Propensity score with subclassification</a></li>
  </ul></li>
  <li><a href="#sec-Appendix" id="toc-sec-Appendix" class="nav-link" data-scroll-target="#sec-Appendix"> <span class="header-section-number">2.4</span> 付録：推定結果の保存と表示</a>
  <ul class="collapse">
  <li><a href="#dot-and-whisker-plotによる可視化" id="toc-dot-and-whisker-plotによる可視化" class="nav-link" data-scroll-target="#dot-and-whisker-plotによる可視化"> <span class="header-section-number">2.4.1</span> Dot-and-Whisker plotによる可視化</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-ParameterLinearEstimation" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">線形モデルによるパラメータの推定</span></span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<ul>
<li><p>関心のあるパラメータ<span class="math inline">\(\tau(X)=E[Y|d,X]-E[Y|d',X]\)</span>を埋め込んだ線形モデルを推定する。</p>
<ul>
<li>典型的には、<span class="math inline">\(E[Y|D,X]\)</span>を線形近似し、推定する。</li>
</ul></li>
</ul>
<p><span class="math display">\[E[Y|D=d,X=x]=\underbrace{\tau}_{Interest\ parameter}\times d+\underbrace{f(x)}_{Nuisance\ function}\]</span> - <span class="math inline">\(f(X)=\beta_0 + \beta_1 X_1 + ...+\beta_LX_L\)</span></p>
<ul>
<li><p><span class="math inline">\(\tau\)</span>について点推定だけでなく、信頼区間も推定する。</p>
<ul>
<li><p><a href="#sec-ParameterEstimation">Section&nbsp;<span>2.2</span></a> 線形モデルを推定し、信頼区間を計算する方法を紹介</p></li>
<li><p><a href="#sec-Matching">Section&nbsp;<span>2.3</span></a> 近似モデルの定式化への依存度を下げるために、マッチング法を用いた前処理を導入</p></li>
<li><p><a href="#sec-Appendix">Section&nbsp;<span>2.4</span></a>推定結果の表によるまとめ、可視化、および複数の推定結果を効率的に保存する方法を紹介</p></li>
</ul></li>
</ul>
<section id="パッケージ-データ" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="パッケージ-データ"><span class="header-section-number">2.1</span> パッケージ &amp; データ</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(AER)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr) <span class="co"># Estimation with robust standard error</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt) <span class="co"># Matching for preprocess</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"CPSSW9204"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><a href="https://declaredesign.org/r/estimatr/">estimatr</a></p></li>
<li><p><a href="https://kosukeimai.github.io/MatchIt/">MatchIt</a></p></li>
</ul>
</section>
<section id="sec-ParameterEstimation" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="sec-ParameterEstimation"><span class="header-section-number">2.2</span> パラメータの推定</h2>
<ul>
<li><p><span class="math inline">\(\tau(x)=\tau,f(x)=\beta_0+\beta_1x_1+...+\beta_Lx_L\)</span>と特定化</p></li>
<li><p>サンプル内MSEを最大化するように推定</p></li>
<li><p>robust standard errorを計算するためにestimatrパッケージを利用</p></li>
<li><p>lm_robust関数で推定</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm_robust</span>(earnings <span class="sc">~</span> degree <span class="sc">+</span> gender <span class="sc">+</span> age <span class="sc">+</span> year, <span class="co"># Outcome ~ Treatment + Controls</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> CPSSW9204)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Estimate Std. Error    t value      Pr(&gt;|t|)   CI Lower
(Intercept)    -1.3734240 0.56012981  -2.451974  1.421837e-02 -2.4713435
degreebachelor  5.6693812 0.11409767  49.688844  0.000000e+00  5.4457365
genderfemale   -2.5584302 0.10555849 -24.237085 2.042463e-127 -2.7653371
age             0.3999398 0.01870067  21.386388 4.880841e-100  0.3632843
year2004        4.7218644 0.10448036  45.193798  0.000000e+00  4.5170708
                 CI Upper    DF
(Intercept)    -0.2755044 15583
degreebachelor  5.8930259 15583
genderfemale   -2.3515232 15583
age             0.4365953 15583
year2004        4.9266581 15583</code></pre>
</div>
</div>
<ul>
<li><p>線形モデルによる推定は、いくつかの問題がある</p>
<ul>
<li><p>異なるグループ間で、<span class="math inline">\(X\)</span>の分布が異なる場合、回帰式の定式化に強く依存する</p></li>
<li><p>一般に平均効果ではなく、加重平均が推計される</p></li>
<li><p>サンプルサイズに比べて、少数のコントロール変数を導入できない</p></li>
</ul></li>
<li><p>以下ではマッチング法、機械学手法を用いた頑強な推定を目指す</p></li>
</ul>
<section id="rctデータへの応用" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="rctデータへの応用"><span class="header-section-number">2.2.1</span> RCTデータへの応用</h3>
<ul>
<li><p>原因変数が完全にランダム化されている場合、因果効果の<strong>識別</strong>を目的に回帰分析を応用する必要はない</p></li>
<li><p>因果効果の<strong>推定</strong>の改善、効率性向上、を目的とした線形モデルの利用は議論されてきた</p></li>
<li><p><span class="citation" data-cites="lin2013">Lin (<a href="references.html#ref-lin2013" role="doc-biblioref">2013</a>)</span> は、以下のような交差項を導入したモデルを用いることで、平均の差の推定に比べて、漸近的効率性が悪化することはない（同等か改善する）ことを示した</p></li>
</ul>
<p><span class="math display">\[E[Y|D,X]=\beta_{D}\times D+\beta_1\times X_1+...+\beta_L\times X_L\]</span></p>
<p><span class="math display">\[+\underbrace{\beta_{1D}\times D\times X_1+...+\beta_{LD}\times D\times X_L}_{交差項}\]</span></p>
<ul>
<li>lm_lin関数で推定可能</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm_lin</span>(earnings <span class="sc">~</span> degree, <span class="co"># Outcome ~ Treatment</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>       <span class="sc">~</span> gender <span class="sc">+</span> age <span class="sc">+</span> year, <span class="co"># ~ Controls</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">data =</span> CPSSW9204)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                Estimate Std. Error     t value      Pr(&gt;|t|)
(Intercept)                   11.8445518 0.05886786 201.2057631  0.000000e+00
degreebachelor                 5.6534529 0.11317582  49.9528355  0.000000e+00
genderfemale_c                -2.5004885 0.11301520 -22.1252401 7.932323e-107
age_c                          0.2554277 0.02057814  12.4125730  3.276989e-35
year2004_c                     3.7186028 0.11834727  31.4211113 3.546993e-210
degreebachelor:genderfemale_c -0.1059052 0.22219513  -0.4766317  6.336311e-01
degreebachelor:age_c           0.3271382 0.03945813   8.2907675  1.216210e-16
degreebachelor:year2004_c      2.3273241 0.22003125  10.5772436  4.657042e-26
                                CI Lower   CI Upper    DF
(Intercept)                   11.7291640 11.9599396 15580
degreebachelor                 5.4316151  5.8752907 15580
genderfemale_c                -2.7220114 -2.2789655 15580
age_c                          0.2150921  0.2957633 15580
year2004_c                     3.4866284  3.9505772 15580
degreebachelor:genderfemale_c -0.5414335  0.3296230 15580
degreebachelor:age_c           0.2497957  0.4044807 15580
degreebachelor:year2004_c      1.8960373  2.7586110 15580</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-Matching" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="sec-Matching"><span class="header-section-number">2.3</span> マッチング法による修正</h2>
<ul>
<li><p>回帰を行う事前準備としてマッチング法を利用する</p>
<ul>
<li><p>重回帰が持つ関数形への依存度を減らせる <span class="citation" data-cites="ho2007">(<a href="references.html#ref-ho2007" role="doc-biblioref">Ho et al. 2007</a>)</span></p></li>
<li><p>MathItパッケージを利用</p></li>
</ul></li>
<li><p>多数のマッチング法が実装されている</p></li>
</ul>
<section id="coarsened-exact-matching" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="coarsened-exact-matching"><span class="header-section-number">2.3.1</span> Coarsened exact matching</h3>
<ul>
<li><p>Coarsened exact matching <span class="citation" data-cites="iacus2012">(<a href="references.html#ref-iacus2012" role="doc-biblioref">Iacus, King, and Porro 2012</a>)</span>の実装</p>
<ul>
<li>連続変数をカテゴリー変数化することで、マッチングできるサンプルサイズを増やすことが期待できる</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fit.m <span class="ot">&lt;-</span> <span class="fu">matchit</span>(degree <span class="sc">~</span> gender <span class="sc">+</span> age <span class="sc">+</span> year,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> CPSSW9204,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">"CEM"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>マッチング結果の表示</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>fit.m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: Coarsened exact matching
 - number of obs.: 15588 (original), 15588 (matched)
 - target estimand: ATT
 - covariates: gender, age, year</code></pre>
</div>
</div>
<ul>
<li><p>Sample sizesにて、マッチングできなかったサンプル数（985のコントロールグループ中、667サンプルがマッチングできなかった）が確認できる</p></li>
<li><p>マッチング結果の図示</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fit.m <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">abs =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ParameterEstimation_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>マッチング結果を変数として含んだデータを作成</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">match.data</span>(fit.m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>“subclass”: マッチングしたグループ</p></li>
<li><p>“weights”：マッチング後の推計に用いるウェイト</p></li>
<li><p>マッチングしたデータを用いた推定</p>
<ul>
<li>新たに作成されるweight (defaltではweights)を用いた、加重推定で実装</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm_robust</span>(earnings <span class="sc">~</span> degree <span class="sc">+</span> gender <span class="sc">+</span> age <span class="sc">+</span> year,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>          df,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">weights =</span> weights,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">clusters =</span> subclass)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Estimate Std. Error     t value     Pr(&gt;|t|)   CI Lower
(Intercept)    -0.9406001 1.06964454  -0.8793577 3.900258e-01 -3.1770482
degreebachelor  5.6973701 0.29536430  19.2892987 8.424314e-21  5.0987422
genderfemale   -2.5534913 0.19585455 -13.0376918 1.521310e-14 -2.9520114
age             0.3855614 0.03430666  11.2386741 8.520762e-10  0.3137177
year2004        4.6549789 0.18737754  24.8427793 1.299149e-23  4.2743968
                 CI Upper       DF
(Intercept)     1.2958479 19.29879
degreebachelor  6.2959981 36.70388
genderfemale   -2.1549711 32.88904
age             0.4574051 18.84870
year2004        5.0355610 34.52932</code></pre>
</div>
</div>
</section>
<section id="propensity-score-with-subclassification" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="propensity-score-with-subclassification"><span class="header-section-number">2.3.2</span> Propensity score with subclassification</h3>
<ul>
<li><p>Coarsened exact matchingでもマッチングできないサンプルが多数出てくる可能性</p>
<ul>
<li>とくに<span class="math inline">\(X\)</span>が大量にある場合</li>
</ul></li>
<li><p>1次元の距離指標を用いて、マッチングを行う</p>
<ul>
<li>距離指標としては、Mahalanobis’ Distance、Propensity scoreなど</li>
</ul></li>
<li><p>ここではPropensity score <span class="math inline">\(p_d(X)\)</span>を用いる</p></li>
</ul>
<p><span class="math display">\[p_d(X)\equiv \Pr[D=d|X]\]</span></p>
<ul>
<li><p>属性<span class="math inline">\(X\)</span>のユニットの中で、原因変数の値が<span class="math inline">\(d\)</span>である人の割合</p></li>
<li><p>未知の場合、データから推定する必要がある</p></li>
<li><p>推定された傾向スコアを用いたStratification マッチング</p>
<p>-　ロジットにて傾向スコアを推定</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fit.m <span class="ot">&lt;-</span> <span class="fu">matchit</span>(degree <span class="sc">~</span> gender <span class="sc">+</span> age <span class="sc">+</span> year,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> CPSSW9204,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">"subclass"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">estimand =</span> <span class="st">"ATE"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>マッチング結果</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit.m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = degree ~ gender + age + year, data = CPSSW9204, 
    method = "subclass", estimand = "ATE")

Summary of Balance for All Data:
             Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance            0.4310        0.4180          0.2320     1.1147    0.0648
gendermale          0.5291        0.6167         -0.1779          .    0.0877
genderfemale        0.4709        0.3833          0.1779          .    0.0877
age                29.6460       29.7982         -0.0534     1.0019    0.0152
year1992            0.4487        0.5164         -0.1358          .    0.0677
year2004            0.5513        0.4836          0.1358          .    0.0677
             eCDF Max
distance       0.1109
gendermale     0.0877
genderfemale   0.0877
age            0.0288
year1992       0.0677
year2004       0.0677

Summary of Balance Across Subclasses
             Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance            0.4239        0.4232          0.0118     1.0127    0.0041
gendermale          0.5787        0.5812         -0.0050          .    0.0025
genderfemale        0.4213        0.4188          0.0050          .    0.0025
age                29.7479       29.7332          0.0052     0.9890    0.0035
year1992            0.4828        0.4902         -0.0148          .    0.0074
year2004            0.5172        0.5098          0.0148          .    0.0074
             eCDF Max
distance       0.0130
gendermale     0.0025
genderfemale   0.0025
age            0.0079
year1992       0.0074
year2004       0.0074

Sample Sizes:
              Control Treated
All           8986.   6602.  
Matched (ESS) 8881.41 6483.64
Matched       8986.   6602.  
Unmatched        0.      0.  
Discarded        0.      0.  </code></pre>
</div>
</div>
<ul>
<li>マッチング結果の図示</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fit.m <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">abs =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ParameterEstimation_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>マッチングしたデータを用いた推定</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm_robust</span>(earnings <span class="sc">~</span> degree <span class="sc">+</span> gender <span class="sc">+</span> age <span class="sc">+</span> year,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>          df,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">weights =</span> weights,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">clusters =</span> subclass)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Estimate Std. Error     t value     Pr(&gt;|t|)   CI Lower
(Intercept)    -0.9406001 1.06964454  -0.8793577 3.900258e-01 -3.1770482
degreebachelor  5.6973701 0.29536430  19.2892987 8.424314e-21  5.0987422
genderfemale   -2.5534913 0.19585455 -13.0376918 1.521310e-14 -2.9520114
age             0.3855614 0.03430666  11.2386741 8.520762e-10  0.3137177
year2004        4.6549789 0.18737754  24.8427793 1.299149e-23  4.2743968
                 CI Upper       DF
(Intercept)     1.2958479 19.29879
degreebachelor  6.2959981 36.70388
genderfemale   -2.1549711 32.88904
age             0.4574051 18.84870
year2004        5.0355610 34.52932</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-Appendix" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="sec-Appendix"><span class="header-section-number">2.4</span> 付録：推定結果の保存と表示</h2>
<section id="dot-and-whisker-plotによる可視化" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="dot-and-whisker-plotによる可視化"><span class="header-section-number">2.4.1</span> Dot-and-Whisker plotによる可視化</h3>
<ul>
<li>Dot-and-Whisker図により点推定量と信頼区間を可視化</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fit.m <span class="ot">&lt;-</span> <span class="fu">matchit</span>(degree <span class="sc">~</span> gender <span class="sc">+</span> age <span class="sc">+</span> year,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> CPSSW9204,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">"CEM"</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">match.data</span>(fit.m)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>Result1 <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(earnings <span class="sc">~</span> degree <span class="sc">+</span> gender <span class="sc">+</span> age <span class="sc">+</span> year,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df) <span class="sc">|&gt;</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>() <span class="sc">|&gt;</span> </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"degreebachelor"</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">|&gt;</span> </span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"OLS"</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>Result1 <span class="sc">|&gt;</span> </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> term,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">x =</span> estimate,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">xmin =</span> conf.low,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">xmax =</span> conf.high)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">+</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>() <span class="sc">+</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ParameterEstimation_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>Result2 <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(earnings <span class="sc">~</span> degree <span class="sc">+</span> gender <span class="sc">+</span> age,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">weights =</span> weights,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">clusters =</span> subclass) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"degreebachelor"</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">|&gt;</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Matching + OLS"</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>Result1 <span class="sc">|&gt;</span> </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(Result2) <span class="sc">|&gt;</span> </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> Method,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">x =</span> estimate,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">xmin =</span> conf.low,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">xmax =</span> conf.high)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">+</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>() <span class="sc">+</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ParameterEstimation_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-ho2007" class="csl-entry" role="doc-biblioentry">
Ho, Daniel E., Kosuke Imai, Gary King, and Elizabeth A. Stuart. 2007. <span>“Matching as Nonparametric Preprocessing for Reducing Model Dependence in Parametric Causal Inference.”</span> <em>Political Analysis</em> 15 (3): 199–236. <a href="https://doi.org/10.1093/pan/mpl013">https://doi.org/10.1093/pan/mpl013</a>.
</div>
<div id="ref-iacus2012" class="csl-entry" role="doc-biblioentry">
Iacus, Stefano M., Gary King, and Giuseppe Porro. 2012. <span>“Causal Inference Without Balance Checking: Coarsened Exact Matching.”</span> <em>Political Analysis</em> 20 (1): 1–24. <a href="https://doi.org/10.1093/pan/mpr013">https://doi.org/10.1093/pan/mpr013</a>.
</div>
<div id="ref-lin2013" class="csl-entry" role="doc-biblioentry">
Lin, Winston. 2013. <span>“Agnostic Notes on Regression Adjustments to Experimental Data: Reexamining Freedman<span>’</span>s Critique.”</span> <em>The Annals of Applied Statistics</em> 7 (1): 295–318. <a href="https://doi.org/10.1214/12-AOAS583">https://doi.org/10.1214/12-AOAS583</a>.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./intro.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">準備</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./summary.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">記述統計</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>