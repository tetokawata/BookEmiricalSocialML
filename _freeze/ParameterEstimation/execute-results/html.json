{
  "hash": "bd47cccf423c6f4ad2f1035cda447def",
  "result": {
    "markdown": "# 線形モデルによるパラメータの推定 {#sec-ParameterLinearEstimation}\n\n-   関心のあるパラメータ$\\tau(X)=E[Y|d,X]-E[Y|d',X]$を埋め込んだ線形モデルを推定する。\n\n    -   典型的には、$E[Y|D,X]$を線形近似し、推定する。\n\n\n$$E[Y|D=d,X=x]=\\underbrace{\\tau}_{Interest\\ parameter}\\times d+\\underbrace{f(x)}_{Nuisance\\ function}$$ - $f(X)=\\beta_0 + \\beta_1 X_1 + ...+\\beta_LX_L$\n\n-   $\\tau$について点推定だけでなく、信頼区間も推定する。\n\n    -   [Section -@sec-ParameterEstimation] 線形モデルを推定し、信頼区間を計算する方法を紹介\n\n    -   [Section -@sec-Matching] 近似モデルの定式化への依存度を下げるために、マッチング法を用いた前処理を導入\n\n    -   [Section -@sec-Appendix]推定結果の表によるまとめ、可視化、および複数の推定結果を効率的に保存する方法を紹介\n\n## パッケージ & データ\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(AER)\nlibrary(estimatr) # Estimation with robust standard error\nlibrary(MatchIt) # Matching for preprocess\n\ndata(\"CPSSW9204\")\n```\n:::\n\n-   [estimatr](https://declaredesign.org/r/estimatr/)\n\n-   [MatchIt](https://kosukeimai.github.io/MatchIt/)\n\n## パラメータの推定 {#sec-ParameterEstimation}\n\n-   $\\tau(x)=\\tau,f(x)=\\beta_0+\\beta_1x_1+...+\\beta_Lx_L$と特定化\n\n-   サンプル内MSEを最大化するように推定\n\n-   robust standard errorを計算するためにestimatrパッケージを利用\n\n-   lm_robust関数で推定\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_robust(earnings ~ degree + gender + age + year, # Outcome ~ Treatment + Controls\n          data = CPSSW9204)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 Estimate Std. Error    t value      Pr(>|t|)   CI Lower\n(Intercept)    -1.3734240 0.56012981  -2.451974  1.421837e-02 -2.4713435\ndegreebachelor  5.6693812 0.11409767  49.688844  0.000000e+00  5.4457365\ngenderfemale   -2.5584302 0.10555849 -24.237085 2.042463e-127 -2.7653371\nage             0.3999398 0.01870067  21.386388 4.880841e-100  0.3632843\nyear2004        4.7218644 0.10448036  45.193798  0.000000e+00  4.5170708\n                 CI Upper    DF\n(Intercept)    -0.2755044 15583\ndegreebachelor  5.8930259 15583\ngenderfemale   -2.3515232 15583\nage             0.4365953 15583\nyear2004        4.9266581 15583\n```\n:::\n:::\n\n-   線形モデルによる推定は、いくつかの問題がある\n\n    -   異なるグループ間で、$X$の分布が異なる場合、回帰式の定式化に強く依存する\n\n    -   一般に平均効果ではなく、加重平均が推計される\n\n    -   サンプルサイズに比べて、少数のコントロール変数を導入できない\n\n-   以下ではマッチング法、機械学手法を用いた頑強な推定を目指す\n\n### RCTデータへの応用\n\n-   原因変数が完全にランダム化されている場合、因果効果の**識別**を目的に回帰分析を応用する必要はない\n\n-   因果効果の**推定**の改善、効率性向上、を目的とした線形モデルの利用は議論されてきた\n\n-   @lin2013 は、以下のような交差項を導入したモデルを用いることで、平均の差の推定に比べて、漸近的効率性が悪化することはない（同等か改善する）ことを示した\n\n\n$$E[Y|D,X]=\\beta_{D}\\times D+\\beta_1\\times X_1+...+\\beta_L\\times X_L$$\n\n$$+\\underbrace{\\beta_{1D}\\times D\\times X_1+...+\\beta_{LD}\\times D\\times X_L}_{交差項}$$\n\n\n-   lm_lin関数で推定可能\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_lin(earnings ~ degree, # Outcome ~ Treatment\n       ~ gender + age + year, # ~ Controls\n       data = CPSSW9204)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                                Estimate Std. Error     t value      Pr(>|t|)\n(Intercept)                   11.8445518 0.05886786 201.2057631  0.000000e+00\ndegreebachelor                 5.6534529 0.11317582  49.9528355  0.000000e+00\ngenderfemale_c                -2.5004885 0.11301520 -22.1252401 7.932323e-107\nage_c                          0.2554277 0.02057814  12.4125730  3.276989e-35\nyear2004_c                     3.7186028 0.11834727  31.4211113 3.546993e-210\ndegreebachelor:genderfemale_c -0.1059052 0.22219513  -0.4766317  6.336311e-01\ndegreebachelor:age_c           0.3271382 0.03945813   8.2907675  1.216210e-16\ndegreebachelor:year2004_c      2.3273241 0.22003125  10.5772436  4.657042e-26\n                                CI Lower   CI Upper    DF\n(Intercept)                   11.7291640 11.9599396 15580\ndegreebachelor                 5.4316151  5.8752907 15580\ngenderfemale_c                -2.7220114 -2.2789655 15580\nage_c                          0.2150921  0.2957633 15580\nyear2004_c                     3.4866284  3.9505772 15580\ndegreebachelor:genderfemale_c -0.5414335  0.3296230 15580\ndegreebachelor:age_c           0.2497957  0.4044807 15580\ndegreebachelor:year2004_c      1.8960373  2.7586110 15580\n```\n:::\n:::\n\n## マッチング法による修正 {#sec-Matching}\n\n-   回帰を行う事前準備としてマッチング法を利用する\n\n    -   重回帰が持つ関数形への依存度を減らせる [@ho2007]\n\n    -   MathItパッケージを利用\n\n-   多数のマッチング法が実装されている\n\n### Coarsened exact matching\n\n-   Coarsened exact matching [@iacus2012]の実装\n\n    -   連続変数をカテゴリー変数化することで、マッチングできるサンプルサイズを増やすことが期待できる\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.m <- matchit(degree ~ gender + age + year,\n                 data = CPSSW9204,\n                 method = \"CEM\"\n                 )\n```\n:::\n\n-   マッチング結果の表示\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.m\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nA matchit object\n - method: Coarsened exact matching\n - number of obs.: 15588 (original), 15588 (matched)\n - target estimand: ATT\n - covariates: gender, age, year\n```\n:::\n:::\n\n-   Sample sizesにて、マッチングできなかったサンプル数（985のコントロールグループ中、667サンプルがマッチングできなかった）が確認できる\n\n-   マッチング結果の図示\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.m |> \n  summary() |> \n  plot(abs = FALSE)\n```\n\n::: {.cell-output-display}\n![](ParameterEstimation_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n-   マッチング結果を変数として含んだデータを作成\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- match.data(fit.m)\n```\n:::\n\n-   \"subclass\": マッチングしたグループ\n\n-   \"weights\"：マッチング後の推計に用いるウェイト\n\n-   マッチングしたデータを用いた推定\n\n    -   新たに作成されるweight (defaltではweights)を用いた、加重推定で実装\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_robust(earnings ~ degree + gender + age + year,\n          df,\n          weights = weights,\n          clusters = subclass)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 Estimate Std. Error     t value     Pr(>|t|)   CI Lower\n(Intercept)    -0.9406001 1.06964454  -0.8793577 3.900258e-01 -3.1770482\ndegreebachelor  5.6973701 0.29536430  19.2892987 8.424314e-21  5.0987422\ngenderfemale   -2.5534913 0.19585455 -13.0376918 1.521310e-14 -2.9520114\nage             0.3855614 0.03430666  11.2386741 8.520762e-10  0.3137177\nyear2004        4.6549789 0.18737754  24.8427793 1.299149e-23  4.2743968\n                 CI Upper       DF\n(Intercept)     1.2958479 19.29879\ndegreebachelor  6.2959981 36.70388\ngenderfemale   -2.1549711 32.88904\nage             0.4574051 18.84870\nyear2004        5.0355610 34.52932\n```\n:::\n:::\n\n### Propensity score with subclassification\n\n-   Coarsened exact matchingでもマッチングできないサンプルが多数出てくる可能性\n\n    -   とくに$X$が大量にある場合\n\n-   1次元の距離指標を用いて、マッチングを行う\n\n    -   距離指標としては、Mahalanobis' Distance、Propensity scoreなど\n\n-   ここではPropensity score $p_d(X)$を用いる\n\n\n$$p_d(X)\\equiv \\Pr[D=d|X]$$\n\n\n-   属性$X$のユニットの中で、原因変数の値が$d$である人の割合\n\n-   未知の場合、データから推定する必要がある\n\n-   推定された傾向スコアを用いたStratification マッチング [@imbens2015 の推奨]\n\n    -　ロジットにて傾向スコアを推定\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.m <- matchit(degree ~ gender + age + year,\n                 data = CPSSW9204,\n                 method = \"subclass\",\n                 estimand = \"ATE\"\n                 )\n```\n:::\n\n-   マッチング結果\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(fit.m)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nmatchit(formula = degree ~ gender + age + year, data = CPSSW9204, \n    method = \"subclass\", estimand = \"ATE\")\n\nSummary of Balance for All Data:\n             Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\ndistance            0.4310        0.4180          0.2320     1.1147    0.0648\ngendermale          0.5291        0.6167         -0.1779          .    0.0877\ngenderfemale        0.4709        0.3833          0.1779          .    0.0877\nage                29.6460       29.7982         -0.0534     1.0019    0.0152\nyear1992            0.4487        0.5164         -0.1358          .    0.0677\nyear2004            0.5513        0.4836          0.1358          .    0.0677\n             eCDF Max\ndistance       0.1109\ngendermale     0.0877\ngenderfemale   0.0877\nage            0.0288\nyear1992       0.0677\nyear2004       0.0677\n\nSummary of Balance Across Subclasses\n             Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\ndistance            0.4239        0.4232          0.0118     1.0127    0.0041\ngendermale          0.5787        0.5812         -0.0050          .    0.0025\ngenderfemale        0.4213        0.4188          0.0050          .    0.0025\nage                29.7479       29.7332          0.0052     0.9890    0.0035\nyear1992            0.4828        0.4902         -0.0148          .    0.0074\nyear2004            0.5172        0.5098          0.0148          .    0.0074\n             eCDF Max\ndistance       0.0130\ngendermale     0.0025\ngenderfemale   0.0025\nage            0.0079\nyear1992       0.0074\nyear2004       0.0074\n\nSample Sizes:\n              Control Treated\nAll           8986.   6602.  \nMatched (ESS) 8881.41 6483.64\nMatched       8986.   6602.  \nUnmatched        0.      0.  \nDiscarded        0.      0.  \n```\n:::\n:::\n\n-   マッチング結果の図示\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.m |> \n  summary() |> \n  plot(abs = FALSE)\n```\n\n::: {.cell-output-display}\n![](ParameterEstimation_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n-   マッチングしたデータを用いた推定\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_robust(earnings ~ degree + gender + age + year,\n          df,\n          weights = weights,\n          clusters = subclass)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 Estimate Std. Error     t value     Pr(>|t|)   CI Lower\n(Intercept)    -0.9406001 1.06964454  -0.8793577 3.900258e-01 -3.1770482\ndegreebachelor  5.6973701 0.29536430  19.2892987 8.424314e-21  5.0987422\ngenderfemale   -2.5534913 0.19585455 -13.0376918 1.521310e-14 -2.9520114\nage             0.3855614 0.03430666  11.2386741 8.520762e-10  0.3137177\nyear2004        4.6549789 0.18737754  24.8427793 1.299149e-23  4.2743968\n                 CI Upper       DF\n(Intercept)     1.2958479 19.29879\ndegreebachelor  6.2959981 36.70388\ngenderfemale   -2.1549711 32.88904\nage             0.4574051 18.84870\nyear2004        5.0355610 34.52932\n```\n:::\n:::\n\n## 付録：推定結果の保存と表示 {#sec-Appendix}\n\n### Dot-and-Whisker plotによる可視化\n\n-   Dot-and-Whisker図により点推定量と信頼区間を可視化\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.m <- matchit(degree ~ gender + age + year,\n                 data = CPSSW9204,\n                 method = \"CEM\"\n                 )\n\ndf <- match.data(fit.m)\n\nResult1 <- lm_robust(earnings ~ degree + gender + age + year,\n            data = df) |> \n  tidy() |> \n  filter(term == \"degreebachelor\"\n         ) |> \n  mutate(Method = \"OLS\")\n\nResult1 |> \n  ggplot(aes(y = term,\n             x = estimate,\n             xmin = conf.low,\n             xmax = conf.high)\n         ) +\n  geom_pointrange() +\n  geom_vline(xintercept = 0) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](ParameterEstimation_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nResult2 <- lm_robust(earnings ~ degree + gender + age,\n            data = df,\n            weights = weights,\n            clusters = subclass) |> \n  tidy() |> \n  filter(term == \"degreebachelor\"\n         ) |> \n  mutate(Method = \"Matching + OLS\")\n\nResult1 |> \n  bind_rows(Result2) |> \n  ggplot(aes(y = Method,\n             x = estimate,\n             xmin = conf.low,\n             xmax = conf.high)\n         ) +\n  geom_pointrange() +\n  geom_vline(xintercept = 0) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](ParameterEstimation_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "ParameterEstimation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}